name: 'Build Madronalib'
description: 'Build and install madronalib dependency'
inputs:
  platform:
    description: 'Platform to build for (linux, windows, macos)'
    required: true
runs:
  using: 'composite'
  steps:
    - name: Build madronalib (Linux)
      if: inputs.platform == 'linux'
      shell: bash
      run: |
        git clone -b debug-linux-build-errors-20250822 https://github.com/johnmatter/madronalib.git
        cd madronalib
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DLINUX_ASOUND=ON -DBUILD_TESTS=ON ..
        make -j$(nproc)
        cmake --build . --target tests --verbose
        sudo make install
    - name: Build madronalib (Windows)
      if: inputs.platform == 'windows'
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    - name: Build madronalib (Windows) - Run Commands
      if: inputs.platform == 'windows'
      shell: pwsh
      run: |
        git clone -b debug-windows-build-errors-20250821 https://github.com/johnmatter/madronalib.git
        cd madronalib

        # Enable long paths for Windows
        git config --system core.longpaths true

        mkdir build
        cd build
        cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON -DCMAKE_INSTALL_PREFIX="$env:USERPROFILE\madronalib" --debug-output -DCMAKE_VERBOSE_MAKEFILE=ON ..
        cmake --build . --verbose
        cmake --build . --target tests --verbose
        cmake --install . --prefix "$env:USERPROFILE\madronalib"
    - name: Build madronalib (macOS)
      if: inputs.platform == 'macos'
      shell: bash
      run: |
        git clone -b debug-windows-build-errors-20250821 https://github.com/johnmatter/madronalib.git
        cd madronalib
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON ..
        make -j$(sysctl -n hw.ncpu)
        cmake --build . --target tests --verbose
        sudo make install
